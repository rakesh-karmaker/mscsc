;/*FB_PKG_DELIM*/

__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","WAGetPlatformFromStanzaId","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.isRetroactiveUpload,e=a.mediaType,f=a.msgType,g=a.probeDelayMs,h=a.restoreMethod,i=a.sampleRate,j=a.stanzaId;a=a.triggerSource;return d("MAWQplProxy").startQplUserFlow(c("qpl")._(521473213,"27"),{bool:{isRetroactiveUpload:b},"int":{probeDelayMs:g,sampleRate:i},string:{e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(j),mediaType:e,msgType:f,restoreMethod:h,triggerSource:a}},void 0,c("justknobx")._("3047"))}g.startMediaRestoreProbeQPLFlow=a}),98);
__d("EncryptedBackupsResignCdnUrl",["MAWBridge","MAWConfig","MAWLoggerUtils","WAJids","WAResolvable","WAResultOrError","asyncToGeneratorRuntime","cr:10071"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function a(a){return h.get(a)}function c(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.deliveryObjectId,e=a.mediaType,f=a.msgId,g=a.protocolMsgId;a=a.sortOrderMs;if(b("cr:10071")!==null){var i=(yield b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:g.chat,deliveryObjectId:c,externalId:g.externalId,mediaType:e,sortOrderMs:a}));return!i.success?i:d("WAResultOrError").makeResult(i.value)}else{i=d("MAWLoggerUtils").getInstanceKey();var j=new(d("WAResolvable").Resolvable)();h.set(i,j);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:c,mediaType:e,messageId:g.externalId,msgId:f,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,skipLegacyMediaDownloadFlow:!0,sortOrder:a,threadId:d("WAJids").threadIdForChatJid(g.chat),threadJid:g.chat,traceId:i}}]});return j.promise}});return i.apply(this,arguments)}g.getRestoredCdnUrlResolvable=a;g.resignCdnUrl=c}),98);
__d("MAWGetMediaApi",["MAWDbMediaTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot find xma with xmaId ",""]);h=function(){return a};return a}var i=function(a){var b=a.media;a=a.xmaMediaType;return b==null?null:{media:b,xmaMediaType:a}};b=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READONLY},"getMediaByPlaintextHash",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b)}});c=d("MAWIndexedDb").makeMsgrTransactor({media:a.READONLY},"getMediaByMediaId",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b)}});e=d("MAWIndexedDb").makeMsgrTransactor({media:a.READONLY,xma:a.READONLY},"getMediaByXMAId",function(a){return function(b,c){return a.xma.get(b).then(function(e){if(e==null){c.ERROR(h(),b);return[]}return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.defaultPreviewMediaId).then(function(a){return i({media:a,xmaMediaType:"preview"})}),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.headerMediaId).then(function(a){return i({media:a,xmaMediaType:"headerImage"})}),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.faviconMediaId).then(function(a){return i({media:a,xmaMediaType:"favicon"})})])})}});g.getMediaByPlaintextHash=b;g.getMediaByMediaId=c;g.getMediaByXMAId=e}),98);
__d("MAWGetMsgByProtocolIdApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"getMsgsByProtocolMsgIdsTxn",function(a){return function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b)}});g.getMsgsByProtocolMsgIdsTxn=a}),98);
__d("MAWDeletedMsgApi",["MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({deletedMessages:d("MAWTransactionMode").READONLY},"getDeletedMsgByProtocolIdApi",function(a){return function(b){return a.deletedMessages.get(babelHelpers["extends"]({},b))}});g.getDeletedMsgByProtocolIdApi=a}),98);
__d("MAWIsMsgDeletedWithReason",["MAWDbDeletedMessages","MAWDeletedMsgApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("MAWDeletedMsgApi").getDeletedMsgByProtocolIdApi(a));return!a?!1:a.reason===d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.ChatDelete||a.reason===d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke});return h.apply(this,arguments)}g.isMsgDeletedWithReason=a}),98);
__d("EncryptedBackupsMediaRestoreProbe",["EBUploadMediaPreview","EncryptedBackupsMediaRestoreProbeQpl","EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWDbXMATxns","MAWEbUploadQueue","MAWGetMediaApi","MAWGetMsgByProtocolIdApi","MAWIndexedDb","MAWIsMsgDeletedWithReason","MAWMsgType","MAWTransactionMode","Promise","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["restore media success for ",". mediaType: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["failed to restore media for ",". mediaType: ",", error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["unsupported media type ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["sortOrderMs is required for media restore, but not found for ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["no dbMsg found for "," - msgType: "," - source: ",", retroactive: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["msg is deleted"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["protocolMsgId can't be built for "," - msgType: "," - source: ",", retroactive: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["start probe media backup through ",", is retroactive upload: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot find media for xma with protocolMsgId ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["preview object id is null for recent thumbnail"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["preview object id is null and mediaKeyTimestamp is null"]);t=function(){return a};return a}var u=d("WATagsLogger").TAGS(["MediaRestoreProbe"]),v=c("justknobx")._("2045"),w=1713191110;function a(a){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.isRetroactiveUpload,f=a.triggerSource;a=a.uploadEntity;switch(a.dbMsgType){case d("MAWMsgType").MSG_TYPE.REACTION:case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:return d("WAResultOrError").makeResult("no-attachment-with-msg")}var g=F(),i=a.dbMsgType;i=D(i);i=Math.random()<g*i/100;if(!i)return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult("not-sampled"));var j=b("cr:10071")==null?"sproc":"gql";u.LOG(q(),j,e);yield d("WAPromiseDelays").delayMs(c("gkx")("2067")?5e3:v);var k=d("MAWEbUploadQueue").buildProtocolMsgIdFromEntity(a);if(k==null){u.ERROR(p(),a.msgId,a.dbMsgType,f,e);return d("WAResultOrError").makeError("missing-db-msg")}i=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([k]));var l=i[0];if(l==null){i=(yield d("MAWIsMsgDeletedWithReason").isMsgDeletedWithReason(k));if(i){u.LOG(o());return d("WAResultOrError").makeResult("msg-deleted")}u.ERROR(n(),k,a.dbMsgType,f,e);return d("WAResultOrError").makeError("missing-db-msg")}i=(yield B({dbMsg:l,protocolMsgId:k}));if(i.type==="no-attachment"){u.LOG(m());return d("WAResultOrError").makeResult("no-attachment-with-msg")}a=y(i,l.msgId);if(!a.success)return d("WAResultOrError").makeError([a.error]);i=a.value;a=(yield (h||(h=b("Promise"))).all(i.map(function(a){var b=d("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:e,mediaType:a.serverMediaType,msgType:l.type,probeDelayMs:v,restoreMethod:j,sampleRate:g,stanzaId:k.externalId,triggerSource:f});return z({dbMsg:l,payload:a,protocolMsgId:k}).then(function(a){if(a.success){b.endSuccess();return a}b.endFail(a.error,{string:{failReason:a.error}});return a})["catch"](function(a){b.endFail("runtime-error",{string:{failReason:a.toString()}});return d("WAResultOrError").makeError("runtime-error")})})));i=a.map(function(a){return a.success?null:a.error}).filter(Boolean);return i.length>0?d("WAResultOrError").makeError(i):d("WAResultOrError").makeResult("restore-media-success")});return x.apply(this,arguments)}function y(a,b){var c=[],e=a.type==="xma"?a.medias:[a];e.forEach(function(a){a=a.fullsize;a=a.mediaEntries.get(b);if(a==null)return d("WAResultOrError").makeError("missing-media-entry");a=d("WAMediaUtils").decodeMediaEntryData(a);var e=a.objectId;a=a.serverMediaType;c.push({objectId:e,serverMediaType:a})});a.type==="media-with-preview"&&(c.push({objectId:a.preview.objectId,serverMediaType:"preview"}),a.preview.objectId==null&&(a.preview.mediaKeyTimestamp==null?u.ERROR(t()):a.preview.mediaKeyTimestamp>w&&u.ERROR(s())));return d("WAResultOrError").makeResult(c)}function z(a){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg,c=a.payload;a=a.protocolMsgId;var e=b.msgId,f=b.sortOrderMs;if(f==null){u.ERROR(l(),a);return d("WAResultOrError").makeError("missing-sort-order-ms")}var g=c.objectId;c=c.serverMediaType;if(c==null||g==null)return d("WAResultOrError").makeError("invalid-media-entry");b=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(c,b.type===d("MAWMsgType").MSG_TYPE.XMA);if(b==null){u.ERROR(k(),c);return d("WAResultOrError").makeError("unsupported-media-type")}c=(yield d("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:g,mediaType:b,msgId:e,protocolMsgId:a,sortOrderMs:f}));if(!c.success){u.ERROR(j(),a,b,c.error);return c}u.LOG(i(),a,b);return d("WAResultOrError").makeResult("restore-media-success")});return A.apply(this,arguments)}function B(a){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg;a=a.protocolMsgId;switch(b.type){case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:if(b.plaintextHash==null)return{type:"no-attachment"};var c=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(b.plaintextHash));if(d("EBUploadMediaPreview").getEnableEbUploadMediaPreview()&&c!=null){var e=c==null?void 0:c.mediaEntries.get(b.msgId);if(e!=null){e=d("WAMediaUtils").decodeMediaEntryData(e).downloadableThumbnail;if(e!=null&&e.objectId!=null)return{fullsize:c,preview:e,type:"media-with-preview"}}}return c==null?{type:"no-attachment"}:{fullsize:c,type:"media"};case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:if(b.plaintextHash==null)return{type:"no-attachment"};e=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(b.plaintextHash));return e==null?{type:"no-attachment"}:{fullsize:e,type:"media"};case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return{type:"no-attachment"};default:b.type;c=(yield E(a));return c.length===0?{type:"no-attachment"}:{medias:c.map(function(a){return{fullsize:a}}),type:"xma"}}});return C.apply(this,arguments)}function D(a){switch(a){case d("MAWMsgType").MSG_TYPE.VIDEO:return 13;case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.PTT:return 8;case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.XMA:return 20;default:return 1}}var E=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},"getMediaByXMAId",function(a){return function(b){return d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,b).then(function(a){if(!a.success){u.ERROR(r(),b);return[]}a=a.value;var c=a.defaultPreview,d=a.favicon,e=a.header;a=a.previews;return[c,d,e].concat(a==null?[]:a).filter(Boolean)})}});function F(){return c("gkx")("2067")?100:c("justknobx")._("2722")}g.sampleProbeMediaRestore=a}),98);
__d("MAWEBScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("eb",{concurrency:1,maxConcurrency:1,maxThrottleMs:1e3,timeToStuckMs:3e4}));return h}g.ebScheduler=a}),98);
__d("MAWEbUploadQueue",["EBEnableUnifiedAttachment","EBUnifyLegacyMediaUpload","EBUploadMessages","EncryptedBackupsMediaRestoreProbe","EncryptedBackupsUploadQueue","EncryptedBackupsUtils","MAWBridge","MAWBridgeUpload","MAWEBScheduler","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWGetMsgByProtocolIdApi","WAGetSafeQPLError","WAGlobals","WAJids","WAShiftTimer","WAStanzaUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","gkx","justknobx","performanceAbsoluteNow","promiseDone","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestore: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot get message from db: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found 2"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg not found 1"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);p=function(){return a};return a}var q=d("EncryptedBackupsUploadQueue").logger.TAGS(["labyrinth-web"]),r=new Map();function s(){var a=(h||(h=c("performanceAbsoluteNow")))(),b=!1;for(var e of r.entries()){var f=e[0],g=e[1].addedAtMs;a-g>c("justknobx")._("3472")&&(b=!0,d("MAWEBUploadTrackingUtils").endFailWorkerOnly(f,"message_upload_timeout",{string:{error_description:d("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.MESSAGE_UPLOAD_TIMEOUT}}),r["delete"](f))}return b}var t=null,u=new(d("WAShiftTimer").ShiftTimer)(a),v=null;function w(){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("WAWaitForUserUnblocked").waitForUserUnblocked();var a=!0;if(v!=null)return;v=d("MAWEBScheduler").ebScheduler().task({fn:function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("MAWEBSwitch").isEnabled()){var b=(yield B());b=b.isEmpty;a=!b}else a=!1});function e(){return d.apply(this,arguments)}return e}(),name:"eb_upload",priority:d("WorkerScheduler").BACKGROUND_PRIORITY});v.run().then(function(){v=null,a&&void w()})["catch"](function(b){v=null,q.ERROR(l(),b),r.forEach(function(a,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{error_description:d("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.RUNTIME_ERROR,reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(b)}})}),r.clear(),a&&window.setTimeout(function(){void w()},c("justknobx")._("2366"))})});return x.apply(this,arguments)}function a(){c("MAWEBSwitch").isEnabled()?void B()["catch"](function(a){q.ERROR(p(),a),r.forEach(function(b,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{error_description:d("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.RUNTIME_ERROR,reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}),r.clear(),u.onOrAfter(c("justknobx")._("2366"))}):u.onOrAfter(c("justknobx")._("2366"))}function y(){return z.apply(this,arguments)}function z(){z=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;a=(a=c("qex")._("1457"))!=null?a:!1;a&&t==null&&(t=window.setInterval(s,5e3));if(c("gkx")("5625")){c("promiseDone")(w());return}yield d("WAWaitForUserUnblocked").waitForUserUnblocked();u.onOrBefore(c("justknobx")._("2367"))});return z.apply(this,arguments)}function e(){c("MAWEBSwitch").onSet(function(){c("MAWEBSwitch").isEnabled()&&c("promiseDone")(y())});c("promiseDone")(y());var a=d("EncryptedBackupsUploadQueue").ebUploadQueue();a.subscribe(function(a){a.type==="flush"&&c("promiseDone")(y())})}function A(a){return d("MAWBridge").getBridge().sendAndReceive("event","uploadMessagesToBackup",{checkPoint:[],messages:a,qpl:[]})}function B(){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("EncryptedBackupsUploadQueue").ebUploadQueue(),b=[],e=(yield a.read({filter:function(a){if(a.sortOrderMs==null||d("EncryptedBackupsUtils").entryOlderThan30Days(a.sortOrderMs)){b.push(a.queueId);return!1}else return!r.has(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId))},limit:c("justknobx")._("2368"),order:"desc"}));yield a["delete"](b);if(e.length===0)return{isEmpty:!0};q.LOG(k(),e.length);a=e.map(function(b){var c,e=d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(b.msgId),a=b.isRetroactiveUpload==null?!1:b.isRetroactiveUpload;return{bridgeUploadMessage:d("MAWBridgeUpload").createBridgeUploadMessage({actionType:b.backupActionType===3?2:1,attachmentContextArray:b.attachmentContext,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:((c=b.backupDirective)==null?void 0:c.supplementalKey)!=null?(c=b.backupDirective)==null?void 0:c.originalMsgProtocolId.externalId:b.msgId.externalId,protoMsg:{backupActionType:b.backupActionType,msgId:b.msgId,originalMsgProtocolId:(c=b.backupDirective)==null?void 0:c.originalMsgProtocolId,protobuf:b.protobuf,senderId:b.senderId,serverTs:b.serverTs,sortOrderMs:b.sortOrderMs,supplementalKey:b.supplementalKey},sortOrderMs:b.sortOrderMs||0,threadId:d("WAJids").threadIdForChatJid(b.msgId.chat),traceId:e.toString(),uploadTrackingInstanceKey:e}),isRetroactiveUpload:a,messageType:b.dbMsgType,queueId:b.queueId,triggerSource:(c=b.triggerSource)!=null?c:"unknown"}});if(c("gkx")("8488")||c("qex")._("1682")===!0){var f=(h||(h=c("performanceAbsoluteNow")))();for(var g of a){var i=g.bridgeUploadMessage,l=g.isRetroactiveUpload,m=g.messageType,n=g.queueId,o=g.triggerSource;i.uploadTrackingInstanceKey!=null&&r.set(i.uploadTrackingInstanceKey,{addedAtMs:f,queueId:n});n=(n=i.protoMsg)==null?void 0:n.msgId;if(n!=null&&i.uploadTrackingInstanceKey!=null){n=i.uploadTrackingInstanceKey;d("MAWEBUploadTrackingUtils").startUploadTracking(d("WAStanzaUtils").toStanzaId(i.messageId),m,o,n,!0,l,(n=(m=i.attachmentBackupContext)==null?void 0:(o=m.attachmentInfos)==null?void 0:o.length)!=null?n:0)}}G(e.map(function(a){return a.legacyAttachmentContext}).filter(Boolean));yield A(a.map(function(a){a=a.bridgeUploadMessage;return a}));return{isEmpty:!1}}var p=new Map(),s=[];l=[];var t=[],v=new Map(),w=new Map();i=(h||(h=c("performanceAbsoluteNow")))();for(m of e){o=E(m);if(o==null){c("promiseDone")(d("EncryptedBackupsUploadQueue").ebUploadQueue().ack([m.queueId]));continue}n=d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(m.msgId);r.set(n,{addedAtMs:i,queueId:m.queueId});v.set(o.externalId,(f=m.attachmentContext)!=null?f:t);g=m.msgId.externalId;f=m.originalMsgProtocolId.externalId;g!==f&&w.set(g,{currentExternalId:g,originalMsgExternalId:f});if(!p.has(o.externalId)){p.set(o.externalId,n);d("MAWEBUploadTrackingUtils").startUploadTracking(o.externalId,m.dbMsgType,(g=m.triggerSource)!=null?g:"unknown",n,!0,m.isRetroactiveUpload,(g=m==null?void 0:(f=m.attachmentContext)==null?void 0:f.length)!=null?g:0);s.push(o);l.push({originalMsgId:o,uploadEntity:m})}}p.forEach(function(a,b){d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a,"queue_get_original_msg_ids_done")});n=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn(s)["catch"](function(a){s.forEach(function(b){b=p.get(b.externalId);b!=null?d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,"get_db_msgs_error",{string:{error_description:d("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.ERROR_FETCHING_DB_MESSAGE,reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}}):q.WARN(j(),a)});throw a}));var x=n.map(function(a){return a.externalId});f=l.filter(function(a){return!x.includes(a.originalMsgId.externalId)});f.forEach(function(a){var b=p.get(a.originalMsgId.externalId);if(b!=null){d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"missing_entity_in_maw_db",{string:{missing_msg_id:a.originalMsgId.externalId,msg_type:a.uploadEntity.dbMsgType,trigger_source:(b=a.uploadEntity.triggerSource)!=null?b:"unknown"}})}});var y=new Map();n.forEach(function(a){var b=p.get(a.externalId);if(b==null)return;d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"queue_get_msgs_done");var c=w.get(a.externalId);c!=null&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"external_id_mismatch",{string:{currentExternalId:c.currentExternalId,differing_ids_type:a.type,originalMsgExternalId:c.originalMsgExternalId}});y.set(a.externalId,(b=v.get(a.externalId))!=null?b:t)});F(p,s,n);G(e.map(function(a){return a.legacyAttachmentContext}).filter(Boolean));yield d("EBUploadMessages").uploadMessageFromUploadQueue(n,p,a.map(function(a){return a.bridgeUploadMessage.protoMsg}).filter(Boolean),y);c("gkx")("5625")||u.onOrBefore(c("justknobx")._("2366"));return{isEmpty:!1}});return C.apply(this,arguments)}function f(a,b){return D.apply(this,arguments)}function D(){D=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e,f=d("EncryptedBackupsUploadQueue").ebUploadQueue();b?d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_queue_ack_worker_success"):d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"upload_queue_ack_worker_fail",{string:{error_description:d("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:"failure to ack upload queue"}});e=(e=r.get(a))!=null?e:{queueId:null};var g=e.queueId;if(g==null)return;if(b){e=(yield f.read({filter:function(a){return a.queueId===g},limit:1}));b=e[0];if(b==null)return;void d("EncryptedBackupsMediaRestoreProbe").sampleProbeMediaRestore({isRetroactiveUpload:(e=b.isRetroactiveUpload)!=null?e:!1,triggerSource:(e=b.triggerSource)!=null?e:"unknown",uploadEntity:b})["catch"](function(a){q.ERROR(i(),a)})}yield f.ack([g]);r["delete"](a);c("promiseDone")(y())});return D.apply(this,arguments)}function E(a){var b=a.originalMsgProtocolId;return b.author==null||b.chat==null?null:{author:d("WAGlobals").getMyUserJid()===b.author?d("WAJids").AUTHOR_ME:b.author,chat:b.chat,externalId:a.backupActionType===4?a.msgId.externalId:a.originalMsgProtocolId.externalId}}function F(a,c,e){if(c.length>e.length){var f=new Set(c.map(function(a){return a.externalId}));e.forEach(function(b){if(f.has(b.externalId)){f["delete"](b.externalId);var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{originalMsgType:b.type}}):q.WARN(o())}});f.forEach(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=a.get(b);if(b!=null){var c;d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(b,"upload_queue_msg_not_found");c=(c=r.get(b))!=null?c:{queueId:null};c=c.queueId;r["delete"](b);if(c==null)return;yield d("EncryptedBackupsUploadQueue").ebUploadQueue()["delete"]([c])}else q.WARN(n())});return function(a){return c.apply(this,arguments)}}())}else e.forEach(function(b){var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{originalMsgType:b.type}}):q.WARN(m())})}function G(a){if(a.length===0)return;var b=[];a.forEach(function(a){a!=null&&a.forEach(function(a){b.push({tag:"UploadAttachment",value:a})})});b.length>0&&d("EBUnifyLegacyMediaUpload").getEnableUnifyLegacyMediaUpload()&&!d("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()&&d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:b})}g.scheduleNextRun=y;g.listenForEbUploadQueueFlush=e;g.uploadEBMsgs=B;g.ackWithInstanceKeyWorkerOnly=f;g.buildProtocolMsgIdFromEntity=E}),98);