;/*FB_PKG_DELIM*/

__d("LSAddPollOption",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(39).add({optionId:a[0],pollId:a[1],optionText:a[2],voteCount:b.i64.cast([0,0]),sortKeyVotingTimestamp:a[3],sortKeyCreationTimestamp:a[4]})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxAddPollOptionStoredProcedure";a.__tables__=["poll_options_v2"];e.exports=a}),null);
__d("LSAddPollOptionV2",["LSAddPollOption","LSVerifyPollExists"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return c.storedProcedure(b("LSVerifyPollExists"),a[5],a[1],a[7],a[6],a[8],!1).then(function(a){return a=a,d[0]=a[0],a})},function(e){return d[0]?c.storedProcedure(b("LSAddPollOption"),a[0],a[1],a[2],a[3],a[4],void 0):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxAddPollOptionV2StoredProcedure";a.__tables__=[];e.exports=a}),null);
__d("LSAddPollVote",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.sequence([function(c){return b.db.table(40).add({optionId:a[0],pollId:a[1],contactId:a[2],timestampMs:a[3]})},function(c){return b.forEach(b.filter(b.db.table(39).fetch([[[a[1],a[0]]]]),function(c){return b.i64.eq(c.optionId,a[0])&&b.i64.eq(c.pollId,a[1])&&b.i64.le(c.sortKeyVotingTimestamp,a[3])}),function(b){var c=b.update;b.item;return c({voteCount:a[4],sortKeyVotingTimestamp:a[3]})})}])},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxAddPollVoteStoredProcedure";a.__tables__=["poll_votes_v2","poll_options_v2"];e.exports=a}),null);
__d("LSAddPollVoteV2",["LSAddPollVote","LSVerifyPollExists"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return c.storedProcedure(b("LSVerifyPollExists"),a[5],a[1],a[6],a[3],a[7],!1).then(function(a){return a=a,d[0]=a[0],a})},function(e){return d[0]?c.storedProcedure(b("LSAddPollVote"),a[0],a[1],a[2],a[3],a[4]):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxAddPollVoteV2StoredProcedure";a.__tables__=[];e.exports=a}),null);
__d("LSHandlePlaceholderPollData",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(38).fetch([[[a[0]]]]).next().then(function(c,d){var e=c.done;c=c.value;return e?0:(d=c.item,b.filter(b.db.table(38).fetch([[[a[0]]]]),function(c){return b.i64.eq(c.pollId,a[0])&&b.i64.gt(c.authorityLevel,b.i64.cast([0,80]))}).next().then(function(e){var c=e.done;e.value;return c?b.db.table(38).put({pollId:a[0],authorityLevel:b.i64.cast([0,80]),threadKey:d.threadKey,lastUpdateMessageId:d.lastUpdateMessageId,lastUpdateMessageTimestampMs:d.lastUpdateMessageTimestampMs,lastUpdateMessageEventType:d.lastUpdateMessageEventType,pollType:b.i64.cast([0,0]),pollStage:b.i64.cast([0,1])}):0}))})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxHandlePlaceholderPollDataStoredProcedure";a.__tables__=["polls"];e.exports=a}),null);
__d("LSUpdatePollAdminMessageSummary",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return b.filter(b.db.table(38).fetch([[[a[0]]]]),function(c){return b.i64.eq(c.pollId,a[0])&&b.i64.eq(c.threadKey,a[1])&&([b.i64.cast([0,2]),b.i64.cast([0,3])].some(function(a){return b.i64.eq(c.lastUpdateMessageEventType,a)})&&[b.i64.cast([0,2]),b.i64.cast([0,3])].some(function(c){return b.i64.eq(a[4],c)})||[b.i64.cast([0,4]),b.i64.cast([0,5])].some(function(a){return b.i64.eq(c.lastUpdateMessageEventType,a)})&&[b.i64.cast([0,4]),b.i64.cast([0,5])].some(function(c){return b.i64.eq(a[4],c)}))&&b.i64.gt(a[3],c.lastUpdateMessageTimestampMs)&&c.lastUpdateMessageId!==a[2]}).next().then(function(d,e){var f=d.done;d=d.value;return f?0:(e=d.item,c[0]=e.lastUpdateMessageTimestampMs,b.db.table(12).fetch([[[a[1],b.merge({gt:c[0]},{lt:a[3]})]]]).next().then(function(f){var d=f.done;f.value;return d?b.sequence([function(d){return b.forEach(b.filter(b.db.table(12).fetch([[[a[1],c[0],e.lastUpdateMessageId]]]),function(d){return b.i64.eq(d.threadKey,a[1])&&b.i64.eq(b.i64.cast([0,0]),b.i64.cast([0,0]))&&b.i64.eq(d.timestampMs,c[0])&&d.messageId===e.lastUpdateMessageId}),function(a){return a["delete"]()})},function(c){return b.forEach(b.filter(b.db.table(12).fetch([[[a[1],a[3],a[2]]]]),function(c){return b.i64.eq(c.threadKey,a[1])&&b.i64.eq(b.i64.cast([0,0]),b.i64.cast([0,0]))&&b.i64.eq(c.timestampMs,a[3])&&c.messageId===a[2]}),function(b){var c=b.update;b.item;return c({text:a[5]})})}]):0}))})},function(a){return b.resolve(d)}])}a.__sproc_name__="LSMailboxUpdatePollAdminMessageSummaryStoredProcedure";a.__tables__=["polls","messages"];e.exports=a}),null);